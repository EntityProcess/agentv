# Batch CLI provider demo (synthetic)
#
# Goal: demonstrate a realistic batch pattern for AML screening.
# - Eval cases contain structured `input_messages` objects.
# - A batch runner converts those objects into a CSV input file.
# - The CLI provider runs the batch runner once, producing JSONL output.
# - output_messages in JSONL are automatically converted to trace events for tool_trajectory evaluation.

description: Batch CLI demo (AML screening) using structured input_messages → CSV → JSONL with trace extraction

execution:
  target: batch_cli

cases:
  - id: aml-001
    criteria: |-
      Batch runner returns a JSON object with decision=CLEAR.

    expected_output:
      - role: assistant
        content:
          decision: CLEAR

    input:
      - role: system
        content: |-
          You are a deterministic AML screening batch checker. Do not use external network calls.
      - role: user
        # Structured content object (multiple fields).
        # The example scripts flatten this into CSV columns.
        content:
          request:
            type: aml_screening_check
            jurisdiction: AU
            effective_date: 2025-01-01
          row:
            id: aml-001
            customer_name: Example Customer A
            origin_country: NZ
            destination_country: AU
            transaction_type: INTERNATIONAL_TRANSFER
            amount: 5000
            currency: USD

    execution:
      evaluators:
        - name: decision-check
          type: code_judge
          script: ["bun", "run", "../judges/check-batch-cli-output.ts"]
          cwd: .
        # Verify the aml_screening tool was called using trace extracted from output_messages
        - name: tool-trajectory-check
          type: tool_trajectory
          mode: any_order
          minimums:
            aml_screening: 1

  - id: aml-002
    criteria: |-
      Batch runner returns a JSON object with decision=REVIEW.

    expected_output:
      - role: assistant
        content:
          decision: REVIEW

    input:
      - role: system
        content: You are a deterministic AML screening batch checker.
      - role: user
        content:
          request:
            type: aml_screening_check
            jurisdiction: AU
            effective_date: 2025-01-01
          row:
            id: aml-002
            customer_name: Example Customer B
            origin_country: IR
            destination_country: AU
            transaction_type: INTERNATIONAL_TRANSFER
            amount: 2000
            currency: USD

    execution:
      evaluators:
        - name: decision-check
          type: code_judge
          script: ["bun", "run", "../judges/check-batch-cli-output.ts"]
          cwd: .
        # Verify the aml_screening tool was called using trace extracted from output_messages
        - name: tool-trajectory-check
          type: tool_trajectory
          mode: any_order
          minimums:
            aml_screening: 1

  - id: aml-003
    criteria: |-
      Batch runner returns a JSON object with decision=REVIEW.

    expected_output:
      - role: assistant
        content:
          decision: REVIEW

    input:
      - role: system
        content: You are a deterministic AML screening batch checker.
      - role: user
        content:
          request:
            type: aml_screening_check
            jurisdiction: AU
            effective_date: 2025-01-01
          row:
            id: aml-003
            customer_name: Example Customer C
            origin_country: US
            destination_country: AU
            transaction_type: INTERNATIONAL_TRANSFER
            amount: 25000
            currency: USD

    execution:
      evaluators:
        - name: decision-check
          type: code_judge
          script: ["bun", "run", "../judges/check-batch-cli-output.ts"]
          cwd: .
        # Verify the aml_screening tool was called using trace extracted from output_messages
        - name: tool-trajectory-check
          type: tool_trajectory
          mode: any_order
          minimums:
            aml_screening: 1

  - id: aml-004-not-exist
    criteria: |-
      Batch runner returns a JSON object with decision=REVIEW.

    expected_output:
      - role: assistant
        content:
          decision: REVIEW

    input:
      - role: system
        content: You are a deterministic AML screening batch checker.
      - role: user
        content:
          request:
            type: aml_screening_check
            jurisdiction: AU
            effective_date: 2025-01-01
          row:
            id: aml-003
            customer_name: Example Customer C
            origin_country: US
            destination_country: AU
            transaction_type: INTERNATIONAL_TRANSFER
            amount: 25000
            currency: USD

    execution:
      evaluators:
        - name: decision-check
          type: code_judge
          script: ["bun", "run", "../judges/check-batch-cli-output.ts"]
          cwd: .
        # Verify the aml_screening tool was called using trace extracted from output_messages
        - name: tool-trajectory-check
          type: tool_trajectory
          mode: any_order
          minimums:
            aml_screening: 1
