# Contextual Recall Evaluator
#
# Evaluates whether retrieval context covers all statements in the expected answer.
# This metric identifies gaps where retrieval failed to surface needed information.
#
# Formula: Attributable Statements / Total Statements
#
# Process:
# 1. Extract distinct statements from criteria
# 2. Check if each statement can be attributed to retrieval context
# 3. Score = proportion of attributable statements
#
# Retrieval context is passed via expected_output.tool_calls, which
# represents the expected agent behavior (calling a retrieval tool).

execution:
  evaluators:
    - name: contextual_recall
      type: code_judge
      script: [bun, run, ../scripts/contextual-recall.ts]
      # max_calls: 1 for statement extraction + 1 per statement for attribution
      target:
        max_calls: 15

tests:
  # Test case 1: Perfect recall - all statements supported by retrieval
  # Expected: "Python was created by Guido van Rossum and first released in 1991"
  # Statements: (1) Created by Guido van Rossum, (2) First released in 1991
  # Both statements are covered by retrieval context
  # Score = 2/2 = 1.0
  - id: perfect-recall
    criteria: Python was created by Guido van Rossum and first released in 1991.
    input:
      - role: user
        content: Who created Python and when was it released?
    expected_output:
      - role: assistant
        tool_calls:
          - tool: vector_search
            input:
              query: Python creator release date
            output:
              results:
                - "Python was created by Guido van Rossum while working at CWI in the Netherlands."
                - "Python was first released in 1991 as version 0.9.0."
                - "Guido van Rossum remained Python's lead developer until 2018."
      - role: assistant
        content: Python was created by Guido van Rossum and first released in 1991.

  # Test case 2: Good recall - retrieval covers most key statements
  # Expected: "The Great Wall of China is over 13,000 miles long and was built over centuries by multiple dynasties"
  # Statements: (1) Over 13,000 miles long, (2) Built over centuries, (3) By multiple dynasties
  # All statements covered by retrieval context
  # Score ~ 1.0
  - id: good-recall
    criteria: The Great Wall of China is over 13,000 miles long and was built over many centuries by multiple dynasties.
    input:
      - role: user
        content: How long is the Great Wall of China and how was it built?
    expected_output:
      - role: assistant
        tool_calls:
          - tool: vector_search
            input:
              query: Great Wall of China length construction
            output:
              results:
                - "The Great Wall of China stretches over 13,000 miles (21,000 km)."
                - "Construction of the Great Wall spanned many centuries, from the 7th century BC to the 17th century AD."
                - "Multiple Chinese dynasties contributed to building the wall, including Qin, Han, and Ming."
      - role: assistant
        content: The Great Wall of China is over 13,000 miles long and was built over centuries.

  # Test case 3: Mostly covered recall - retrieval supports most statements
  # Expected: "Mount Everest is 29,032 feet tall and located in the Himalayas on the border of Nepal and Tibet"
  # Retrieval covers height, location, and border info
  # Score ~ 1.0
  - id: covered-recall
    criteria: Mount Everest is 29,032 feet tall and located in the Himalayas on the border of Nepal and Tibet.
    input:
      - role: user
        content: How tall is Mount Everest and where is it located?
    expected_output:
      - role: assistant
        tool_calls:
          - tool: vector_search
            input:
              query: Mount Everest height location
            output:
              results:
                - "Mount Everest stands at 29,032 feet (8,849 meters), making it the tallest mountain on Earth."
                - "Mount Everest is located in the Himalayan mountain range."
                - "The mountain sits on the border between Nepal and the Tibet Autonomous Region of China."
      - role: assistant
        content: Mount Everest is 29,032 feet tall and is in the Himalayas.
