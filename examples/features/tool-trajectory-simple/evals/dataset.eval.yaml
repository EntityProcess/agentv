# AgentV Tool Trajectory Evaluator Demo
# Demonstrates trace events and tool_trajectory evaluator for agent execution tracking
#
# The tool_trajectory evaluator validates that an agent used the expected tools
# during execution. It works with trace data returned by agent providers.
#
# Five trajectory matching modes are available:
# - any_order: Validates minimum tool call counts (tools can appear in any order)
# - in_order: Validates tools appear in expected sequence (allows gaps)
# - exact: Validates exact tool sequence match (no gaps, no extra tools)
# - superset: Every expected tool must be found in actual (extras OK, greedy matching)
# - subset: Every actual call must be in the allowed set (expected items reusable)
#
# Argument matching modes (per-item `args_match` or evaluator-level `args_match`):
# - exact: Bidirectional deep equality, no extra keys (default)
# - superset: Actual args must contain all expected keys (extras OK)
# - subset: Actual args must be a subset of expected (no unexpected keys)
# - ignore: Skip argument checking entirely
# - [field list]: Check only listed fields (dot-notation supported)
#
# Legacy shorthand:
# - args: any - validate tool name only, ignore arguments
# Note: For pattern/regex matching, use a code_judge evaluator instead.
#
# This demo uses a CLI provider (mock-agent.ts) that simulates an agent with tool usage.
# The mock agent generates different traces based on the prompt content.
#
# Setup:
#   1. Create examples/features/.env with:
#      TOOL_TRAJECTORY_DIR=/absolute/path/to/examples/features/tool-trajectory-simple
#   2. Run: cd examples/features && npx agentv eval tool-trajectory-simple/evals/dataset.eval.yaml --target mock_agent

description: Tool trajectory evaluator examples for agent execution validation

# Use mock_agent CLI target that returns trace data
execution:
  target: mock_agent

tests:
  # ==========================================
  # Example 1: any_order mode - Validate minimum tool usage
  # Use case: Ensure agent uses required tools at least N times, regardless of order
  # The mock agent triggers "research" scenario -> knowledgeSearch x2, documentRetrieve x1
  # Expected score: 1.0
  # ==========================================
  - id: any-order-pass

    criteria: |-
      Agent successfully researches the topic by searching knowledge base multiple times
      and retrieving relevant documents.

    input:
      - role: user
        content: Research the key differences between REST and GraphQL APIs.

    assert:
      - name: tool-usage-check
        type: tool_trajectory
        mode: any_order
        minimums:
          knowledgeSearch: 2    # Mock agent calls this 2 times
          documentRetrieve: 1   # Mock agent calls this 1 time

  # ==========================================
  # Example 2: in_order mode - Validate tool sequence
  # Use case: Ensure agent follows a logical workflow order
  # The mock agent triggers "data pipeline" scenario with correct sequence
  # Expected score: 1.0
  # ==========================================
  - id: in-order-pass

    criteria: |-
      Agent follows the correct data processing workflow.

    input:
      - role: user
        content: Process the customer data from the API endpoint.

    assert:
      - name: workflow-sequence
        type: tool_trajectory
        mode: in_order
        expected:
          - tool: fetchData
          - tool: validateSchema
          - tool: transformData
          - tool: saveResults

  # ==========================================
  # Example 3: exact mode - Validate precise tool sequence
  # Use case: Strict workflow validation where exact steps matter
  # The mock agent triggers "auth" scenario with exactly these 3 tools
  # Expected score: 1.0
  # ==========================================
  - id: exact-auth-flow

    criteria: |-
      Agent performs authentication in the exact required sequence.

    input:
      - role: user
        content: Authenticate the user with provided credentials.

    assert:
      - name: auth-sequence-exact
        type: tool_trajectory
        mode: exact
        expected:
          - tool: checkCredentials
          - tool: generateToken
          - tool: auditLog

  # ==========================================
  # Example 4: any_order with metrics tools
  # Use case: Validate agent uses metrics retrieval tools
  # The mock agent triggers "metrics" scenario
  # Expected score: 1.0
  # ==========================================
  - id: metrics-check

    criteria: |-
      Agent uses the metrics tools to check CPU and memory.

    input:
      - role: user
        content: What are the current system metrics for CPU and memory?

    assert:
      - name: metrics-tools
        type: tool_trajectory
        mode: any_order
        minimums:
          getCpuMetrics: 1
          getMemoryMetrics: 1

  # ==========================================
  # Example 5: Partial match - demonstrates scoring
  # Use case: Show partial scoring when some tools are missing
  # The mock agent triggers "research" scenario but we expect an extra tool
  # Expected score: ~0.67 (2 out of 3 tool requirements met)
  # ==========================================
  - id: partial-match

    criteria: |-
      Agent should use search, retrieve, and report tools.

    input:
      - role: user
        content: Search for information and generate a report.

    assert:
      - name: tool-check
        type: tool_trajectory
        mode: any_order
        minimums:
          knowledgeSearch: 1    # Present in research trace (will pass)
          documentRetrieve: 1   # Present in research trace (will pass)
          generateReport: 1     # NOT present (will fail - demonstrates partial scoring)

  # ==========================================
  # ARGUMENT MATCHING EXAMPLES
  # ==========================================

  # ==========================================
  # Example 6: Exact argument matching (default mode)
  # Use case: Validate tool is called with specific argument values
  # Note: With the default `exact` args matching, actual args must match
  # expected args exactly (bidirectional deep equality, no extra keys).
  # ==========================================
  - id: exact-args-match

    criteria: |-
      Agent searches for weather and retrieves forecast for the correct city.

    input:
      - role: user
        content: What's the weather like in Paris?

    assert:
      - name: arg-validation
        type: tool_trajectory
        mode: in_order
        # Use superset args matching to allow extra keys in actual args
        args_match: superset
        expected:
          - tool: search
            args:
              query: "weather Paris"
          - tool: get_weather
            args:
              location: "Paris"

  # ==========================================
  # Example 7: Skip argument validation with `any`
  # Use case: Validate tool sequence but ignore specific arguments
  # ==========================================
  - id: skip-args-validation

    criteria: |-
      Agent loads data, transforms it, and saves. Arguments don't matter.

    input:
      - role: user
        content: Load customer data, normalize it, and save

    assert:
      - name: workflow-sequence-only
        type: tool_trajectory
        mode: in_order
        expected:
          # Superset match: must include this key, extras OK
          - tool: load_data
            args:
              source: "customers"
            args_match: superset
          # Skip: any transformation is acceptable
          - tool: transform
            args: any
          # Skip: we don't care about save arguments
          - tool: save_data
            args: any

  # ==========================================
  # TRAJECTORY MODE EXAMPLES (v2)
  # ==========================================

  # ==========================================
  # Example 8: superset mode - actual trajectory must contain all expected
  # Use case: Verify required tools were called, regardless of order or extras
  # ==========================================
  - id: superset-mode

    criteria: |-
      Agent must call both search and analyze tools during execution.
      Extra tool calls are acceptable.

    input:
      - role: user
        content: Research and analyze the data.

    assert:
      - name: required-tools
        type: tool_trajectory
        mode: superset
        args_match: superset
        expected:
          - tool: knowledgeSearch
          - tool: documentRetrieve

  # ==========================================
  # Example 9: subset mode - all actual calls must be in allowed set
  # Use case: Restrict agent to only use approved tools (safety guardrail)
  # ==========================================
  - id: subset-mode

    criteria: |-
      Agent must only use approved read-only tools.
      No write or delete operations should occur.

    input:
      - role: user
        content: Look up the current system status.

    assert:
      - name: safe-tools-only
        type: tool_trajectory
        mode: subset
        expected:
          - tool: getCpuMetrics
          - tool: getMemoryMetrics
          - tool: knowledgeSearch
          - tool: documentRetrieve

  # ==========================================
  # Example 10: Per-item args_match override
  # Use case: Mixed matching requirements within a single trajectory
  # ==========================================
  - id: mixed-args-match

    criteria: |-
      Agent calls tools with varying argument precision requirements.

    input:
      - role: user
        content: Process the customer data from the API endpoint.

    assert:
      - name: mixed-precision
        type: tool_trajectory
        mode: in_order
        args_match: ignore  # Default: don't check args
        expected:
          - tool: fetchData
          - tool: validateSchema
          - tool: transformData
          - tool: saveResults

  # ==========================================
  # Example 11: Field list args matching
  # Use case: Check only specific fields in tool arguments
  # ==========================================
  - id: field-list-match

    criteria: |-
      Agent fetches data from the correct source.
      Other arguments like pagination or format don't matter.

    input:
      - role: user
        content: Process the customer data from the API endpoint.

    assert:
      - name: check-source-only
        type: tool_trajectory
        mode: in_order
        expected:
          - tool: fetchData
            args:
              source: "api"
            args_match:
              - source  # Only check this field
          - tool: saveResults
            args_match: ignore  # Don't check args at all
