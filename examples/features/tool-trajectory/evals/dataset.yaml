# AgentV Tool Trajectory Evaluator Demo
# Demonstrates trace events and tool_trajectory evaluator for agent execution tracking
#
# The tool_trajectory evaluator validates that an agent used the expected tools
# during execution. It works with trace data returned by agent providers.
#
# Three matching modes are available:
# - any_order: Validates minimum tool call counts (tools can appear in any order)
# - in_order: Validates tools appear in expected sequence (allows gaps)
# - exact: Validates exact tool sequence match (no gaps, no extra tools)
#
# Argument matching:
# - Exact: args: { key: "value" } - must match exactly (deep equality)
# - Skip: args: any - validate tool name only, ignore arguments
# Note: For pattern/regex matching, use a code_judge evaluator instead.
#
# This demo uses a CLI provider (mock-agent.ts) that simulates an agent with tool usage.
# The mock agent generates different traces based on the prompt content.
#
# Setup:
#   1. Create examples/features/.env with:
#      TOOL_TRAJECTORY_DIR=/absolute/path/to/examples/features/tool-trajectory
#   2. Run: cd examples/features && npx agentv eval tool-trajectory/evals/dataset.yaml --target mock_agent

description: Tool trajectory evaluator examples for agent execution validation

# Use mock_agent CLI target that returns trace data
execution:
  target: mock_agent

evalcases:
  # ==========================================
  # Example 1: any_order mode - Validate minimum tool usage
  # Use case: Ensure agent uses required tools at least N times, regardless of order
  # The mock agent triggers "research" scenario -> knowledgeSearch x2, documentRetrieve x1
  # Expected score: 1.0
  # ==========================================
  - id: any-order-pass

    expected_outcome: |-
      Agent successfully researches the topic by searching knowledge base multiple times
      and retrieving relevant documents.

    input_messages:
      - role: user
        content: Research the key differences between REST and GraphQL APIs.

    execution:
      evaluators:
        - name: tool-usage-check
          type: tool_trajectory
          mode: any_order
          minimums:
            knowledgeSearch: 2    # Mock agent calls this 2 times
            documentRetrieve: 1   # Mock agent calls this 1 time

  # ==========================================
  # Example 2: in_order mode - Validate tool sequence
  # Use case: Ensure agent follows a logical workflow order
  # The mock agent triggers "data pipeline" scenario with correct sequence
  # Expected score: 1.0
  # ==========================================
  - id: in-order-pass

    expected_outcome: |-
      Agent follows the correct data processing workflow.

    input_messages:
      - role: user
        content: Process the customer data from the API endpoint.

    execution:
      evaluators:
        - name: workflow-sequence
          type: tool_trajectory
          mode: in_order
          expected:
            - tool: fetchData
            - tool: validateSchema
            - tool: transformData
            - tool: saveResults

  # ==========================================
  # Example 3: exact mode - Validate precise tool sequence
  # Use case: Strict workflow validation where exact steps matter
  # The mock agent triggers "auth" scenario with exactly these 3 tools
  # Expected score: 1.0
  # ==========================================
  - id: exact-auth-flow

    expected_outcome: |-
      Agent performs authentication in the exact required sequence.

    input_messages:
      - role: user
        content: Authenticate the user with provided credentials.

    execution:
      evaluators:
        - name: auth-sequence-exact
          type: tool_trajectory
          mode: exact
          expected:
            - tool: checkCredentials
            - tool: generateToken
            - tool: auditLog

  # ==========================================
  # Example 4: any_order with metrics tools
  # Use case: Validate agent uses metrics retrieval tools
  # The mock agent triggers "metrics" scenario
  # Expected score: 1.0
  # ==========================================
  - id: metrics-check

    expected_outcome: |-
      Agent uses the metrics tools to check CPU and memory.

    input_messages:
      - role: user
        content: What are the current system metrics for CPU and memory?

    execution:
      evaluators:
        - name: metrics-tools
          type: tool_trajectory
          mode: any_order
          minimums:
            getCpuMetrics: 1
            getMemoryMetrics: 1

  # ==========================================
  # Example 5: Partial match - demonstrates scoring
  # Use case: Show partial scoring when some tools are missing
  # The mock agent triggers "research" scenario but we expect an extra tool
  # Expected score: ~0.67 (2 out of 3 tool requirements met)
  # ==========================================
  - id: partial-match

    expected_outcome: |-
      Agent should use search, retrieve, and report tools.

    input_messages:
      - role: user
        content: Search for information and generate a report.

    execution:
      evaluators:
        - name: tool-check
          type: tool_trajectory
          mode: any_order
          minimums:
            knowledgeSearch: 1    # Present in research trace (will pass)
            documentRetrieve: 1   # Present in research trace (will pass)
            generateReport: 1     # NOT present (will fail - demonstrates partial scoring)

  # ==========================================
  # ARGUMENT MATCHING EXAMPLES
  # ==========================================

  # ==========================================
  # Example 6: Exact argument matching
  # Use case: Validate tool is called with specific argument values
  # ==========================================
  - id: exact-args-match

    expected_outcome: |-
      Agent searches for weather and retrieves forecast for the correct city.

    input_messages:
      - role: user
        content: What's the weather like in Paris?

    execution:
      evaluators:
        - name: arg-validation
          type: tool_trajectory
          mode: in_order
          expected:
            - tool: search
              args:
                query: "weather Paris"
            - tool: get_weather
              args:
                location: "Paris"

  # ==========================================
  # Example 7: Skip argument validation with `any`
  # Use case: Validate tool sequence but ignore specific arguments
  # ==========================================
  - id: skip-args-validation

    expected_outcome: |-
      Agent loads data, transforms it, and saves. Arguments don't matter.

    input_messages:
      - role: user
        content: Load customer data, normalize it, and save

    execution:
      evaluators:
        - name: workflow-sequence-only
          type: tool_trajectory
          mode: in_order
          expected:
            # Exact match: must use specific source
            - tool: load_data
              args:
                source: "customers"
            # Skip: any transformation is acceptable
            - tool: transform
              args: any
            # Skip: we don't care about save arguments
            - tool: save_data
              args: any
