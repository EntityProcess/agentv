# Field Accuracy Evaluation Dataset
#
# This dataset demonstrates the built-in `field_accuracy` evaluator for per-evalcase scoring.
# Use this pattern when you need simple pass/fail scoring per field.
#
# For aggregatable TP/TN/FP/FN metrics across documents, see confusion-metrics.yaml instead.
#
# Evaluation patterns demonstrated:
# - Exact matching for invoice numbers and currency codes
# - Date matching with format normalization
# - Numeric tolerance for currency amounts
# - Fuzzy matching via code_judge plugins
# - Line item array validation
#
description: Field accuracy evaluator patterns (per-evalcase scoring)

execution:
  target: mock_extractor
  evaluators:
    # Primary evaluator: Correctness via field-level accuracy
    - name: invoice_field_accuracy
      type: field_accuracy
      fields:
        # Header fields
        - path: invoice_number
          match: exact
          required: true
          weight: 2.0
        - path: invoice_date
          match: date
          formats: ["DD-MMM-YYYY", "YYYY-MM-DD", "MM/DD/YYYY"]
          required: true
          weight: 1.0
        - path: currency
          match: exact
          required: true
          weight: 1.0
        
        # Party information
        # Note: For fuzzy matching (OCR variations), use code_judge with fuzzy_match.ts
        - path: supplier.name
          match: exact
          required: true
          weight: 1.0
        - path: supplier.address
          match: exact
          required: false
          weight: 0.5
        - path: importer.name
          match: exact
          required: true
          weight: 1.0
        - path: importer.address
          match: exact
          required: false
          weight: 0.5
        
        # Totals - numeric tolerance for rounding
        - path: net_total
          match: numeric_tolerance
          tolerance: 1.0
          relative: false
          required: true
          weight: 3.0
        - path: gross_total
          match: numeric_tolerance
          tolerance: 1.0
          relative: false
          required: true
          weight: 3.0
      
      aggregation: weighted_average
    
    # Alternative: Rubric-based evaluation ("Rubric as Object" pattern)
    # Demonstrates AgentV's structured evaluation goal with human-readable criteria
    # - name: invoice_extraction_rubric
    #   type: rubric
    #   rubrics:
    #     - id: header_completeness
    #       description: "Invoice number, date, and currency extracted correctly"
    #       weight: 1.0
    #       required: true
    #     - id: party_accuracy
    #       description: "Supplier and importer names and addresses match expected format"
    #       weight: 1.0
    #       required: true
    #     - id: financial_precision
    #       description: "Net and gross totals within acceptable tolerance (±$1)"
    #       weight: 2.0
    #       required: true
    #     - id: line_items_completeness
    #       description: "All line items extracted with descriptions, quantities, and amounts"
    #       weight: 1.5
    #       required: false
    
    # Execution metrics evaluators (optional, require provider to report metrics)
    # - name: performance_check
    #   type: latency
    #   threshold: 2000  # max allowed duration in milliseconds
    # - name: cost_tracking
    #   type: cost
    #   budget: 0.10  # max allowed cost in USD per eval case

evalcases:
  # ============================================
  # Test Case 1: CMA CGM Shipping Invoice
  # Perfect extraction scenario
  # ============================================
  - id: invoice-001
    conversation_id: document-extraction
    expected_outcome: |
      Extractor produces clean data matching expected ground truth.
      Mock extractor rounds supplier name from "Acme - Shipping" to "Acme Shipping" in HTML.
      All numeric values rounded to integers (1889 not 1889.00).
      Tests that exact matching passes when extractor normalizes data correctly.
    expected_output:
      - role: assistant
        content:
          invoice_number: "INV-2025-001234"
          invoice_date: "15-JAN-2025"
          incoterm: null
          currency: "USD"
          net_total: 1889
          gross_total: 1889
          supplier:
            name: "Acme Shipping"
            address: "Acme - Shipping\n123 Harbor Boulevard\nSuite 400\n90001  Los Angeles\nUSA"
          importer:
            name: "Global Trade Co"
            address: "Global Trade Co\n456 Commerce Street\n10001  New York\nUSA"
          line_items:
            - description: "OCEAN FREIGHT"
              quantity: 1
              unit_price: 1370
              line_total: 1370
              unit_type: "C2 1 USD"
              hs_code: "853720"
            - description: "Bunker Adjustment Factor"
              quantity: 1
              unit_price: 262
              line_total: 262
              unit_type: "C2 1 TEU"
              hs_code: "853720"
            - description: "Container maintenance Fee at destination"
              quantity: 1
              unit_price: 20
              line_total: 20
              unit_type: "C2 1 TEU"
              hs_code: "853720"
            - description: "Advanced Manifest Declaration Fee"
              quantity: 1
              unit_price: 32
              line_total: 32
              unit_type: "C2 1 FIX"
              hs_code: "853720"
            - description: "Energy Transition Surcharge"
              quantity: 1
              unit_price: 68
              line_total: 68
              unit_type: "C2 1 TEU"
              hs_code: "853720"
            - description: "Emergency Operational Recovery"
              quantity: 1
              unit_price: 75
              line_total: 75
              unit_type: "C2 1 UNI"
              hs_code: "853720"
            - description: "On carriage chassis admin fees"
              quantity: 1
              unit_price: 12
              line_total: 12
              unit_type: "C2 1 UNI"
              hs_code: "853720"
            - description: "On Carriage Additional - Emergency Fuel Surch."
              quantity: 1
              unit_price: 50
              line_total: 50
              unit_type: "C2 1 UNI"
              hs_code: "853720"
    input:
      - role: user
        content:
          - type: file
            value: ../fixtures/invoice-001.json
          - type: text
            value: |
              Extract all structured data from this commercial shipping invoice.
              Return a JSON object with invoice header, party details, line items, and totals.

  # ============================================
  # Test Case 2: Supplier Name Spacing Variation
  # Demonstrates fuzzy matching via code_judge with config pass-through
  # ============================================
  - id: invoice-002
    conversation_id: document-extraction
    expected_outcome: |
      ACTUAL EXTRACTOR OUTPUT: supplier.name = "Acme - Shipping" (preserves document punctuation)
      EXPECTED GROUND TRUTH: supplier.name = "Acme Shipping" (normalized)

      This simulates OCR output that preserves document formatting.
      Uses code_judge with config pass-through for multi-field fuzzy matching.
    evaluators:
      # Multi-field fuzzy match with config pass-through
      - name: party_names_fuzzy
        type: code_judge
        script: ["bun", "run", "../judges/multi_field_fuzzy.ts"]
        # These properties are passed to the script via stdin config
        fields:
          - path: supplier.name
            threshold: 0.85
          - path: importer.name
            threshold: 0.90
        algorithm: levenshtein
      # Exact/numeric matching for other fields
      - name: other_fields
        type: field_accuracy
        fields:
          - path: invoice_number
            match: exact
            required: true
          - path: invoice_date
            match: date
            formats: ["DD-MMM-YYYY", "YYYY-MM-DD"]
          - path: currency
            match: exact
          - path: net_total
            match: numeric_tolerance
            tolerance: 1.0
    expected_output:
      - role: assistant
        content:
          invoice_number: "INV-2025-001234"
          invoice_date: "15-JAN-2025"
          currency: "USD"
          net_total: 1889
          gross_total: 1889
          supplier:
            name: "Acme Shipping"
          importer:
            name: "Global Trade Co"
    input:
      - role: user
        content:
          - type: file
            value: ../fixtures/invoice-002.json
          - type: text
            value: "Extract invoice header and party names."

  # ============================================
  # Test Case 3: Amount Rounding Tolerance
  # Tests numeric tolerance for total amounts
  # ============================================
  - id: invoice-003
    conversation_id: document-extraction
    expected_outcome: |
      ACTUAL EXTRACTOR OUTPUT: net_total = 1889.5, gross_total = 1889.5
      EXPECTED GROUND TRUTH: net_total = 1889, gross_total = 1889
      
      Mock extractor output sample (`invoice-003.json`) contains 1889.5 USD (preserved decimals).
      Numeric tolerance (±1.0) should accept 0.5 difference and pass.
    expected_output:
      - role: assistant
        content:
          invoice_number: "INV-2025-001234"
          invoice_date: "15-JAN-2025"
          currency: "USD"
          net_total: 1889
          gross_total: 1889
          supplier:
            name: "Acme - Shipping"
          importer:
            name: "Global Trade Co"
    input:
      - role: user
        content:
          - type: file
            value: ../fixtures/invoice-003.json
          - type: text
            value: "Extract invoice totals."

  # ============================================
  # Test Case 4: Missing Required Fields
  # Tests evaluation failure when critical fields missing
  # ============================================
  - id: invoice-004
    conversation_id: document-extraction
    expected_outcome: |
      ACTUAL EXTRACTOR OUTPUT: invoice_number = undefined (field missing in fixture)
      EXPECTED GROUND TRUTH: invoice_number = "INV-2025-001234"

      Tests required field validation. Score should drop significantly due to
      missing critical field (weight 2.0). Expected score ~0.85 (lose 2/13 weight).
    expected_output:
      - role: assistant
        content:
          invoice_number: "INV-2025-001234"  # Expected but missing in candidate
          invoice_date: "15-JAN-2025"
          currency: "USD"
          net_total: 1889
          gross_total: 1889
          supplier:
            name: "Acme - Shipping"
          importer:
            name: "Global Trade Co"
    input:
      - role: user
        content:
          - type: file
            value: ../fixtures/invoice-004.json
          - type: text
            value: "Extract invoice data (incomplete extraction)."

  # ============================================
  # Test Case 5: Line Items Array Validation
  # Tests nested field path extraction with array indexing
  # ============================================
  - id: invoice-005
    conversation_id: document-extraction
    expected_outcome: |
      Extractor correctly extracts first two line items with proper array structure.
      Field paths like line_items[0].description should resolve correctly.
    evaluators:
      - name: line_items_check
        type: field_accuracy
        fields:
          - path: line_items[0].description
            match: exact
            required: true
            weight: 1.0
          - path: line_items[0].line_total
            match: numeric_tolerance
            tolerance: 1.0
            required: true
            weight: 1.0
          - path: line_items[1].description
            match: exact
            required: true
            weight: 1.0
          - path: line_items[1].line_total
            match: numeric_tolerance
            tolerance: 1.0
            required: true
            weight: 1.0
        aggregation: weighted_average
    expected_output:
      - role: assistant
        content:
          line_items:
            - description: "OCEAN FREIGHT"
              line_total: 1370
            - description: "Bunker Adjustment Factor"
              line_total: 262
    input:
      - role: user
        content:
          - type: file
            value: ../fixtures/invoice-005.json
          - type: text
            value: "Extract first two line items from invoice."

  # ============================================
  # Test Case 6: Line Item Reorder (Greedy Matching)
  # Demonstrates line-item matching where order differs
  # ============================================
  - id: invoice-006
    conversation_id: document-extraction
    expected_outcome: |
      ACTUAL EXTRACTOR OUTPUT: line_items in different order than expected
      EXPECTED GROUND TRUTH: line_items in original order

      This test demonstrates greedy matching for line items.
      Index-based comparison would incorrectly penalize the extractor,
      but greedy matching correctly aligns items by description similarity.
    evaluators:
      - name: line_items_matched
        type: code_judge
        script: ["bun", "run", "../judges/line_item_matching.ts"]
        match_fields: ["description"]
        score_fields: ["description", "quantity", "line_total"]
        threshold: 0.8
        line_items_path: line_items
    expected_output:
      - role: assistant
        content:
          line_items:
            - description: "OCEAN FREIGHT"
              quantity: 1
              line_total: 120
            - description: "Bunker Adjustment Factor"
              quantity: 1
              line_total: 80
    input:
      - role: user
        content:
          - type: file
            value: ../fixtures/invoice-006.json
          - type: text
            value: "Extract line items from invoice (may be reordered)."

